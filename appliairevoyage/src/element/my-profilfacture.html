<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->


<dom-module id="my-profilfacture">

  <template>
		<style>
  		</style>
  		
  	 	<my-profil_behavior 
  	 		id="profilfacture"
	  		table_code="facture" 
	  		params_get="{{params_get}}"
	  		params_save="{{params_save}}"
	  		params_delete="{{params_delete}}"
	  		edited_item_id="{{edited_item_id}}"
  	 	 	objet="{{objet}}" 
  	 	 	obj_id="{{objet.id}}"
  	 	 	parent="{{parent}}"
  	 	 	parentfield_id="titulaire_id"
  	 	 	doc_print_link="{{doc_print_link}}"
  	 	 	grants_acces="{{grants_acces}}"
  	 	 	hideother_onedit="{{hideother_onedit}}"
  	 	 	hideothereditbutton_onedit="{{hideothereditbutton_onedit}}"
  	 	 	return_onsave=true
  		> 
  		

	  		
	  		<div class="reduit">
				{{objet.facture_num}}, {{objet.date}}, Montant {{objet.libelle}}
	  		</div>
	  		
	  		
	  		<div class="edition">
			    <paper-input id="id" label="id" hidden type="text" value="{{objet.id}}"> </paper-input>
			    <paper-input id="uuid" label="uuid" hidden type="text" value="{{objet.uuid}}">     </paper-input>    
				<div class="ligne">
					<paper-input class="input05cols" id="date" label="Date" required type="date" value="{{objet.date}}"></paper-input>
		            <paper-input class="input05cols" disable id="facture_num" label="Numéro facture" disabled type="text" value="{{objet.facture_num}}"></paper-input>
				</div>
			    <div class="ligne">
				 	 <paper-input class="input3cols" id="libelle" label="Libelle" required  type="text" value="{{objet.libelle}}"></paper-input>
				</div>          
				<template is="dom-repeat" items="{{comptesecritures_asso}}">
					<div>[[item.recu_num]] du [[item.date]], [[item.type_operation]] de [[item.montant]]€</div>
				</template>
	  		</div>
  		 		
  		
  		</my-profil_behavior>
	  <iron-ajax
		id="get_new_facture_num"			    method="GET"
	    url="{{new_facture_url}}"	    		headers="{{app.header_auth}}"
	    params="{{params_new_facture.params}}"	handle-as="json"   	on-error="_disconnect"
	    last-response="{{new_facture}}"   		debounce-duration="300"
	    on-response="set_facture">
	</iron-ajax>
  </template>
  <script>
  Polymer({

	  is: 'my-profilfacture',
	  
	  properties: { 
	     app: {
	          type: Object
	        }, 
	  	 params_get:{type: Object,
		   	 	  notify : true,
		   	 	  computed:'_getparams_get(objet.id,objet)'
		     },
	     params_save:{type: Object,
	   	 	  notify : true,
	   	 	  value: {body:{},params:{action:'save',type:'maj',element:'facture'/*v:'voyage.1.1.1'*/}}
	        },
	     params_delete:{type: Object,
	   	 	  notify : true,
	   	 	  value: {body:{},params:{action:'delete',type:'maj',element:'facture'/*v:'voyage.1.1.1'*/}}
	        },
	     params_new_facture:{type: Object,
	   	 	  notify : true,
	   	 	  value: {body:{},params:{action:'getfacture_num',v:'voyage.1.1.1'}}
	        },
	     edited_item_id:{notify : true},
	     
	     doc_print_link:{type:String,
	    	 notify:true,
	    	 computed:'_getprintlink(objet)'}
	     
	  },
	  observers: [
          '_calculfacture_num(objet.id,objet)'
        ],
	  _getprintlink:function(objet){
		  if (objet && objet.id) {
			  return "doc_facture&id="+objet.id;
		  } else {
			  return null;
		  }
		  
	  },
	  _getparams_get:function(obj_id,objet){
		  return {type:'get',action:'detailfacture',id:obj_id}
	  },
	  _calculfacture_num:function(id,objet){

			if(id<0 && objet &&	(objet.facture_num=="" || !objet.facture_num)){
				this.set('objet.facture_num','...');
				this.set('app',this.$.profilfacture.app);
		        this.$.profilfacture.app = document.querySelector('#app');
				this.$.get_new_facture_num.url=this.$.profilfacture.app.url_api+':'+this.$.profilfacture.app.port_api+'/index';//?action=setprogrammation&v=piscine.1.1.1';
		        this.$.get_new_facture_num.generateRequest();
			}
	  },
	  set_facture:function(){
	        this.set('objet.facture_num',this.new_facture.num)  ;
		  
	  },
  });
  
  </script>

</dom-module>
		
<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../bower_components/app-layout/app-grid/app-grid-style.html">
<link rel="import" href="../element/my-profilcompte_ecriture.html">

<dom-module id="my-liste_compte_ecritures">

  <template>
		<style >
		 .add-button{
		 	/*position:fixed;
		 	bottom:50px;
		 	left:50px;*/
		 	float:right;
		 	--paper-fab-background: var(--paper-blue-400);
		    --paper-fab-keyboard-focus-background: var(--paper-blue-900);
		 }
		 .item-title {
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          background-color: rgba(15, 40, 145, 0.5);
          color: white;
          font-weight: 400;
          padding: 16px;
        }
  		</style>

  	<iron-ajax
		id="charge_allcompte_ecritures"
	    method="GET"
	    url="{{charge_allcompte_ecritures_url}}"
	    headers="{{app.header_auth}}"
	    params="{{params_allcompte_ecritures}}"
	    handle-as="json"
	    on-error="_disconnect"
	    last-response="{{compte_ecritures_Response}}"
	    debounce-duration="300">
	</iron-ajax>
		<div class="item-title" >Comptabilité<div style="float:right;">Solde : [[solde]]€</div></div>
		
    <template is="dom-repeat" items="{{titulaire.compte_ecritures}}">
    		
			<my-profilcompte_ecriture contextePrint="{{contextePrint}}" objet="{{item}}" selcompte_ecriture="{{selcompte_ecriture}}" editbuttonhide="{{editbuttonhide}}" ></my-profilcompte_ecriture>
	</template>
	<paper-fab class="add-button" hidden$="[[!button_add_show]]" mini icon="add" title="Créer" on-tap="add"></paper-fab>

  </template>
  <script>
  Polymer({

	  is: 'my-liste_compte_ecritures',
	  
	  properties: {  
	     app: {
	          type: Object
	        },    
  		 params_allcompte_ecritures:{type: Object,
	   	 	  notify : true,
	   	 	  value: {type:'get',action:'listcompte_ecriture',titulaire_id: '=-1'}},
	   	 charge_allcompte_ecritures_url: {type:String, 
	   		    notify : true,
	   		  	value:null },
	     editbuttonhide:{type:Boolean,
	    	 	notify : true,
	    	 	value:false },	     
	     seltitulaire:{type:Number,
		    	 	notify : true,
		    	 	value :-1},
		 selcompte_ecriture:{type:Number,
	    	 	notify : true,
	    	 	value :-1},
   		 solde:{type:Number,
	    	 	notify : true,
	    	 	computed: '_compute_solde(compte_ecritures_Response)'},
		 titulaire:{type: Object,
	    	 notify : true,
	    	 value:{}
	     },
	     addable:{type:Boolean,
	    	 notify:true},
	     button_add_show:{type:Boolean,
	    	 notify:true,
	    	 computed:'_compute_isaddable(addable,editbuttonhide)'
	     },
	     compte_ecritures_Response:{type: Object,
	    	 notify : true
	     }
	  },
	  listeners: {
          'reply_compte_ecriture': 'handleReply',
        },
     observers: [
                  '_titulairechange(seltitulaire,titulaire)',
                  '_titulairecompte_ecriturechange(compte_ecritures_Response)'
                ],
	  add : function(){
		  if (!this.titulaire.compte_ecritures) {
			  this.set('titulaire.compte_ecritures',[]);
		  }
		 this.unshift('titulaire.compte_ecritures', {newobjet:true,id:-1});
		 this.set('seltitulaire',-1);
		 this.set('editmode',true);
		 this.set('editbuttonhide',true);
	  },

	  
	  handleReply:function(e,detail){
		  if (detail.id==-1 && this.titulaire.compte_ecritures.indexOf(detail)>-1) {
			  this.splice('titulaire.compte_ecritures', this.titulaire.compte_ecritures.indexOf(detail), 1);
		  }
	  },
	  _compute_solde:function(compte_ecritures_Response){
		  var solde_calc=0;
		  for (l in compte_ecritures_Response) {
			  if(compte_ecritures_Response[l].montant && compte_ecritures_Response[l].calcul_solde=='O'){
				  if (compte_ecritures_Response[l].signe=="-"){
					  solde_calc-=compte_ecritures_Response[l].montant*1;
				  } else {
					  solde_calc+=compte_ecritures_Response[l].montant*1;
				  }
			  }
		  }
		  return solde_calc;
	  },
	  _compute_isaddable:function(addable,editbuttonhide){
		  if (addable && !editbuttonhide){
			  return true;
		  }  else {
			  return false;
		  }
	  },
	  _titulairechange:function(seltitulaire,titulaire){
		  if(seltitulaire==titulaire.id && seltitulaire>=0 ){
		        this.app = document.querySelector('#app');
		        this.set('params_allcompte_ecritures.titulaire_id','='+seltitulaire);
		    	this.charge_allcompte_ecritures_url=this.app.url_api+':'+this.app.port_api+'/index'
		    	this.$.charge_allcompte_ecritures.generateRequest();
		  }
	  },
	  _titulairecompte_ecriturechange:function(compte_ecritures_Response){
		  this.set('titulaire.compte_ecritures',compte_ecritures_Response);
		  this.notifyPath('titulaire.compte_ecritures');
	  },
	  _disconnect: function(obj){
	    	  this.app = document.querySelector('#app');
	    	  return this.app.disconnect();
	      },
	  _toArray: function(obj){
	    	  return this.app._toArray(obj);
	      },

  })
  </script>

</dom-module>

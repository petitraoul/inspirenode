<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../bower_components/app-layout/app-grid/app-grid-style.html">
<link rel="import" href="../element/my-profilfacture.html">

<dom-module id="my-liste_factures">

  <template>
		<style >
		 .add-button{
		 	/*position:fixed;
		 	bottom:50px;
		 	left:50px;*/
		 	float:right;
		 	--paper-fab-background: var(--paper-blue-400);
		    --paper-fab-keyboard-focus-background: var(--paper-blue-900);
		 }
		 .item-title {
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          background-color: rgba(200, 26, 76, 0.5);
          color: white;
          font-weight: 400;
          padding: 16px;
        }
  		</style>

  	<iron-ajax
		id="charge_allfactures"
	    method="GET"
	    url="{{charge_allfactures_url}}"
	    headers="{{app.header_auth}}"
	    params="{{params_allfactures}}"
	    handle-as="json"
	    on-error="_disconnect"
	    last-response="{{factures_Response}}"
	    debounce-duration="300">
	</iron-ajax>
		<div class="item-title" >Factures</div>
		
    <template is="dom-repeat" items="{{titulaire.factures}}">
			<my-profilfacture comptesecritures={{titulaire.compte_ecritures}} contextePrint="{{contextePrint}}" objet="{{item}}" selfacture="{{selfacture}}" editbuttonhide="{{editbuttonhide}}" ></my-profilfacture>
			
	</template>
	<paper-fab class="add-button" hidden$="[[!button_add_show]]" mini icon="add" title="CrÃ©er" on-tap="add"></paper-fab>

  </template>
  <script>
  Polymer({

	  is: 'my-liste_factures',
	  
	  properties: {  
	     app: {
	          type: Object
	        },    
  		 params_allfactures:{type: Object,
	   	 	  notify : true,
	   	 	  value: {type:'get',action:'listfacture',titulaire_id: '=-1'}},
	   	 charge_allfactures_url: {type:String, 
	   		    notify : true,
	   		  	value:null },
	     editbuttonhide:{type:Boolean,
	    	 	notify : true,
	    	 	value:false },	     
	     seltitulaire:{type:Number,
		    	 	notify : true,
		    	 	value :-1},
		 selfacture:{type:Number,
	    	 	notify : true,
	    	 	value :-1},
   		 solde:{type:Number,
	    	 	notify : true,
	    	 	computed: '_compute_solde(factures_Response)'},
		 titulaire:{type: Object,
	    	 notify : true,
	    	 value:{}
	     },
	     addable:{type:Boolean,
	    	 notify:true},
	     button_add_show:{type:Boolean,
	    	 notify:true,
	    	 computed:'_compute_isaddable(addable,editbuttonhide)'
	     },
	     factures_Response:{type: Object,
	    	 notify : true
	     },
   	     compte_ecritures_Response:{type: Object,
	    	 notify : true
	     }
	  },
	  listeners: {
          'reply_facture': 'handleReply',
        },
     observers: [
                  '_titulairechange(seltitulaire,titulaire)',
                  '_titulairefacturechange(factures_Response)'
                ],
	  add : function(){
		  if (!this.titulaire.factures) {
			  this.set('titulaire.factures',[]);
		  }
		 this.unshift('titulaire.factures', {newobjet:true,id:-1});
		 this.set('seltitulaire',-1);
		 this.set('editmode',true);
		 this.set('editbuttonhide',true);
	  },

	  
	  handleReply:function(e,detail){
		  if (detail.id==-1 && this.titulaire.factures.indexOf(detail)>-1) {
			  this.splice('titulaire.factures', this.titulaire.factures.indexOf(detail), 1);
		  }
	  },
	  _compute_solde:function(factures_Response){
		  var solde_calc=0;
		  for (l in factures_Response) {
			  if(factures_Response[l].montant){
				  solde_calc+=factures_Response[l].montant*1;
			  }
		  }
		  return solde_calc;
	  },
	  _compute_isaddable:function(addable,editbuttonhide){
		  if (addable && !editbuttonhide){
			  return true;
		  }  else {
			  return false;
		  }
	  },
	  _titulairechange:function(seltitulaire,titulaire){
		  if(seltitulaire==titulaire.id && seltitulaire>=0 ){
		        this.app = document.querySelector('#app');
		        this.set('params_allfactures.titulaire_id','='+seltitulaire);
		    	this.charge_allfactures_url=this.app.url_api+':'+this.app.port_api+'/index'
		    	this.$.charge_allfactures.generateRequest();
		  }
	  },
	  _titulairefacturechange:function(factures_Response){
		  this.set('titulaire.factures',factures_Response);
		  this.notifyPath('titulaire.factures');
	  },
	  _disconnect: function(obj){
	    	  this.app = document.querySelector('#app');
	    	  return this.app.disconnect();
	      },
	  _toArray: function(obj){
	    	  return this.app._toArray(obj);
	      },

  })
  </script>

</dom-module>
